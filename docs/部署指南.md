# 服务器部署指南

本指南将帮助您在新服务器上安装 Docker、Docker Compose，并运行 nginx-shop 项目。

## ⚠️ 关于 root 用户

**如果您只有 root 用户，可以直接使用 root 运行安装脚本。**

脚本会自动检测并使用 root 权限，无需使用 `sudo`。

**为什么不建议使用 root？**
- 安全风险：root 权限过大，误操作可能影响整个系统
- 文件权限：创建的文件可能属于 root，后续普通用户无法修改
- 最佳实践：遵循最小权限原则

**建议（可选）：** 如果可能，创建一个普通用户：
```bash
# 创建用户
adduser yourusername

# 添加到 sudo 组
usermod -aG sudo yourusername

# 切换到新用户
su - yourusername
```

---

## 一、安装 Docker

### 1.1 更新系统包（Ubuntu/Debian）

```bash
sudo apt-get update
sudo apt-get install -y ca-certificates curl gnupg lsb-release
```

### 1.2 添加 Docker 官方 GPG 密钥

```bash
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
```

### 1.3 设置 Docker 仓库

```bash
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

### 1.4 安装 Docker Engine

```bash
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

### 1.5 启动 Docker 服务

```bash
sudo systemctl start docker
sudo systemctl enable docker
```

### 1.6 验证 Docker 安装

```bash
sudo docker --version
sudo docker run hello-world
```

### 1.7 将当前用户添加到 docker 组（可选，避免每次使用 sudo）

```bash
sudo usermod -aG docker $USER
# 需要重新登录或执行以下命令使组权限生效
newgrp docker
```

---

## 二、安装 Docker Compose

### 方法一：使用 Docker Compose Plugin（推荐，已包含在 Docker 安装中）

如果您按照上面的步骤安装了 Docker，Docker Compose Plugin 已经包含在内。验证安装：

```bash
docker compose version
```

### 方法二：独立安装 Docker Compose（如果方法一不可用）

```bash
# 下载最新版本的 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 添加执行权限
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker-compose --version
```

---

## 三、部署项目

### 3.1 上传项目文件到服务器

您可以使用以下方式之一：

**方式一：使用 SCP 命令（从本地 Windows 机器）**

```powershell
# 在 Windows PowerShell 中执行
scp -r D:\MyProject\tool_project\nginx-shop username@服务器IP:/home/username/
```

**方式二：使用 Git（如果项目在 Git 仓库中）**

```bash
git clone <your-repo-url>
cd nginx-shop
```

**方式三：使用 FTP/SFTP 工具**

使用 FileZilla、WinSCP 等工具上传项目文件夹。

### 3.2 进入项目目录

```bash
cd nginx-shop
```

### 3.3 确保 logs 目录存在

```bash
mkdir -p logs
```

### 3.4 构建并启动容器

```bash
# 使用 Docker Compose Plugin（推荐）
docker compose up -d --build

# 或者使用独立版本的 docker-compose
docker-compose up -d --build
```

### 3.5 查看容器状态

```bash
docker compose ps
# 或
docker-compose ps
```

### 3.6 查看日志

```bash
docker compose logs -f
# 或
docker-compose logs -f
```

---

## 四、配置防火墙

### 4.1 Ubuntu/Debian 使用 UFW

```bash
# 开放 8083 端口（根据 docker-compose.yml 中的端口配置）
sudo ufw allow 8083/tcp
sudo ufw reload
```

### 4.2 CentOS/RHEL 使用 firewalld

```bash
sudo firewall-cmd --permanent --add-port=8083/tcp
sudo firewall-cmd --reload
```

### 4.3 云服务器（阿里云/腾讯云/华为云等）

需要在云服务器控制台的**安全组**中开放 8083 端口。

---

## 五、访问网站

启动成功后，在浏览器中访问：

```
http://服务器IP:8083
```

例如：`http://192.168.1.100:8083`

---

## 六、常用管理命令

### 6.1 停止服务

```bash
docker compose down
# 或
docker-compose down
```

### 6.2 重启服务

```bash
docker compose restart
# 或
docker-compose restart
```

### 6.3 查看实时日志

```bash
docker compose logs -f nginx
# 或
docker-compose logs -f nginx
```

### 6.4 重新构建并启动（修改代码后）

```bash
docker compose up -d --build
# 或
docker-compose up -d --build
```

### 6.5 进入容器内部

```bash
docker exec -it nginx-shop sh
```

### 6.6 查看容器资源使用情况

```bash
docker stats nginx-shop
```

---

## 七、故障排查

### 7.1 检查 Docker 服务状态

```bash
sudo systemctl status docker
```

### 7.2 检查容器日志

```bash
docker compose logs nginx
```

### 7.3 检查端口占用

```bash
sudo netstat -tulpn | grep 8083
# 或
sudo ss -tulpn | grep 8083
```

### 7.4 如果端口被占用，修改 docker-compose.yml

编辑 `docker-compose.yml`，修改端口映射：

```yaml
ports:
  - "新端口:80"  # 例如 "8080:80"
```

然后重新启动：

```bash
docker compose down
docker compose up -d --build
```

---

## 八、一键安装脚本（可选）

您也可以创建一个自动化安装脚本。创建 `install.sh` 文件：

```bash
#!/bin/bash

# 安装 Docker
sudo apt-get update
sudo apt-get install -y ca-certificates curl gnupg lsb-release
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 启动 Docker
sudo systemctl start docker
sudo systemctl enable docker

# 将当前用户添加到 docker 组
sudo usermod -aG docker $USER

# 创建 logs 目录
mkdir -p logs

# 启动项目
docker compose up -d --build

echo "安装完成！请访问 http://$(hostname -I | awk '{print $1}'):8083"
```

使用脚本：

```bash
chmod +x install.sh
./install.sh
```

---

## 注意事项

1. **端口冲突**：确保服务器上的 8083 端口未被占用
2. **防火墙**：记得在云服务器控制台和安全组中开放端口
3. **权限问题**：如果遇到权限问题，可以使用 `sudo` 执行命令
4. **日志查看**：项目日志保存在 `logs/` 目录下
5. **数据持久化**：logs 目录已挂载，日志会保存在宿主机上

---

## 完成！

现在您的 Nginx 展示网站应该已经成功运行在服务器上了！

