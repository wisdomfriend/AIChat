# 域名配置指南

本指南将帮助您将购买的域名指向您的服务器，并配置 Nginx 使其能够通过域名访问。

## 📋 前提条件

- 已购买域名（例如：guopengfei.top）
- 服务器 IP 地址：12.218.18.10
- 服务器已安装并运行 Nginx 服务（端口 80）

---

## 第一步：配置 DNS 解析

### 1.1 登录域名管理平台

根据您购买域名的服务商（如阿里云、腾讯云、GoDaddy 等），登录到域名管理控制台。

### 1.2 添加 A 记录

在域名管理控制台中，找到 **"DNS解析"** 或 **"域名解析"** 功能，添加以下 DNS 记录：

| 记录类型 | 主机记录 | 记录值 | TTL |
|---------|---------|--------|-----|
| A | @ | 12.218.18.10 | 600（或默认值） |
| A | www | 12.218.18.10 | 600（或默认值） |

**说明：**
- **@** 表示根域名（例如：guopengfei.top）
- **www** 表示 www 子域名（例如：www.guopengfei.top）
- **记录值** 填写您的服务器 IP：12.218.18.10
- **TTL** 可以设置为 600 秒（10分钟）或使用默认值

### 1.2.1 DNS 记录类型说明

#### 常见 DNS 记录类型

| 记录类型 | 英文全称 | 用途 | 示例 |
|---------|---------|------|------|
| **A** | Address | 将域名指向 IPv4 地址 | `guopengfei.top` → `12.218.18.10` |
| **AAAA** | IPv6 Address | 将域名指向 IPv6 地址 | `guopengfei.top` → `2001:db8::1` |
| **CNAME** | Canonical Name | 将域名指向另一个域名（别名） | `www.guopengfei.top` → `guopengfei.top` |
| **MX** | Mail Exchange | 指定邮件服务器地址 | `guopengfei.top` → `mail.example.com` |
| **TXT** | Text | 文本记录，用于验证、SPF 等 | 用于域名验证、邮件安全配置 |
| **NS** | Name Server | 指定域名服务器 | 通常由域名注册商自动配置 |

#### 什么是 MX 记录？

**MX 记录（Mail Exchange，邮件交换记录）** 用于指定处理该域名邮件的邮件服务器。

**使用场景：**
- 如果您想使用 `yourname@guopengfei.top` 这样的邮箱地址
- 需要配置 MX 记录指向您的邮件服务器

**MX 记录配置示例：**

| 记录类型 | 主机记录 | 记录值 | 优先级 | TTL |
|---------|---------|--------|--------|-----|
| MX | @ | mail.example.com | 10 | 600 |
| MX | @ | mail2.example.com | 20 | 600 |

**说明：**
- **优先级**：数字越小，优先级越高。邮件会优先发送到优先级高的服务器
- **记录值**：通常是邮件服务器的域名（如 `mail.example.com`），而不是 IP 地址
- **主机记录**：通常填写 `@`（根域名）

**注意：** 如果您只是搭建网站，**不需要配置 MX 记录**。只有需要使用该域名的邮箱功能时才需要配置。

#### 什么是 TTL？

**TTL（Time To Live，生存时间）** 表示 DNS 记录在 DNS 缓存服务器中的有效时间（单位：秒）。

**工作原理：**
1. 当用户访问您的域名时，DNS 服务器会查询域名对应的 IP 地址
2. 查询结果会被缓存到本地 DNS 服务器或用户的设备中
3. 在 TTL 时间内，再次访问时会直接使用缓存的结果，不再查询
4. TTL 时间到期后，缓存失效，需要重新查询

**TTL 值的选择：**

| TTL 值 | 适用场景 | 优点 | 缺点 |
|--------|---------|------|------|
| **300-600 秒**<br>（5-10分钟） | 经常需要修改 DNS 记录 | 修改后生效快 | 查询频率高，可能影响性能 |
| **3600 秒**<br>（1小时） | 一般网站（推荐） | 平衡性能和灵活性 | - |
| **86400 秒**<br>（24小时） | 稳定不变的配置 | 减少 DNS 查询，提高性能 | 修改后生效慢 |

**建议：**
- **首次配置或测试阶段**：设置为 600 秒（10分钟），方便快速验证修改效果
- **稳定运行后**：可以设置为 3600 秒（1小时）或更长
- **如果 IP 地址经常变化**：保持较短的 TTL 值（如 600 秒）
- **如果 IP 地址固定不变**：可以使用较长的 TTL 值（如 86400 秒）

**示例：**
```
TTL = 600 秒
→ 修改 DNS 记录后，最多 10 分钟后全球生效
→ 但本地 DNS 缓存可能还需要额外时间清除

TTL = 86400 秒
→ 修改 DNS 记录后，可能需要 24 小时后才完全生效
→ 但首次访问的用户会立即使用新记录
```

### 1.3 等待 DNS 生效

DNS 解析通常需要 **5 分钟到 48 小时** 才能全球生效，但大多数情况下在 **10-30 分钟** 内就会生效。

**验证 DNS 是否生效：**

在 Windows PowerShell 或命令提示符中执行：

```powershell
# 检查根域名解析
nslookup guopengfei.top

# 检查 www 子域名解析
nslookup www.guopengfei.top
```

或者在 Linux/Mac 中执行：

```bash
# 检查根域名解析
dig guopengfei.top

# 检查 www 子域名解析
dig www.guopengfei.top
```

如果返回的 IP 地址是 `12.218.18.10`，说明 DNS 解析已生效。

---

## 第二步：配置 Nginx

### 2.1 修改 Nginx 配置文件

编辑 `nginx/nginx.conf` 文件，将 `server_name` 从 `localhost` 改为您的域名：

```nginx
server {
    listen 80;
    server_name guopengfei.top www.guopengfei.top;  # 修改这里
    # ... 其他配置 ...
}
```

### 2.1.1 为什么需要修改 server_name？

**常见疑问：** 我的 `server_name` 是 `localhost`，但通过域名也能访问，还需要改吗？

**答案：** 虽然不改也能访问，但**强烈建议改为实际域名**。

#### 为什么 localhost 也能通过域名访问？

Nginx 有一个**默认 server 块**机制：

1. 当请求的 `Host` 头不匹配任何 `server_name` 时
2. Nginx 会使用**默认的 server 块**（通常是第一个，或标记为 `default_server` 的）
3. 所以即使 `server_name` 是 `localhost`，通过域名访问也能工作

**示例：**
```nginx
# 配置 1：server_name 是 localhost
server {
    listen 80;
    server_name localhost;  # 不匹配域名请求
    # 但 Nginx 会使用这个作为默认 server，所以域名访问也能工作
}
```

#### 为什么要改为实际域名？

虽然不改也能工作，但改为实际域名有以下**重要好处**：

| 原因 | 说明 |
|------|------|
| **规范性和明确性** | 配置更清晰，明确表示这个 server 块是为哪个域名服务的 |
| **多域名支持** | 如果将来需要配置多个域名或多个 server 块，可以精确匹配不同的域名 |
| **HTTPS 证书** | 配置 SSL 证书时，证书验证需要正确的 `server_name` 匹配 |
| **日志准确性** | 访问日志中会显示正确的域名，便于分析和排查问题 |
| **安全性** | 避免 Host 头攻击，确保只有指定的域名才能访问 |
| **性能优化** | Nginx 可以更快地匹配到正确的 server 块 |

**示例场景：**

如果您将来需要配置多个网站：

```nginx
# 网站 1：guopengfei.top
server {
    listen 80;
    server_name guopengfei.top www.guopengfei.top;
    root /var/www/site1;
}

# 网站 2：another-domain.com
server {
    listen 80;
    server_name another-domain.com;
    root /var/www/site2;
}
```

如果 `server_name` 都是 `localhost`，Nginx 无法区分应该使用哪个配置。

#### 总结

- **不改也能用**：技术上可以，但不规范
- **建议改为域名**：更专业、更安全、更灵活
- **必须改的情况**：配置 HTTPS、多域名、需要精确匹配时

### 2.2 重新构建并启动容器

```bash
# 停止当前容器
docker compose down

# 重新构建并启动
docker compose up -d --build
```

---

## 第三步：配置防火墙

### 3.1 确保服务器防火墙开放 80 端口

**Ubuntu/Debian (UFW):**

```bash
sudo ufw allow 80/tcp
sudo ufw reload
```

**CentOS/RHEL (firewalld):**

```bash
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --reload
```

### 3.2 云服务器安全组配置

如果您的服务器在云平台（阿里云、腾讯云、华为云等），还需要在**云服务器控制台**的**安全组**中开放 80 端口：

1. 登录云服务器控制台
2. 找到您的服务器实例
3. 进入 **安全组** 设置
4. 添加入站规则：
   - **端口**：80
   - **协议**：TCP
   - **源**：0.0.0.0/0（允许所有 IP 访问）

---

## 第四步：测试访问

### 4.1 等待 DNS 生效后测试

在浏览器中访问：

```
http://guopengfei.top
```

或

```
http://www.guopengfei.top
```

如果能看到您的网站，说明配置成功！

### 4.2 如果无法访问，检查以下内容

1. **DNS 是否生效**：使用 `nslookup` 或 `dig` 命令检查
2. **服务器是否运行**：`docker compose ps` 查看容器状态
3. **端口是否开放**：检查防火墙和安全组设置
4. **Nginx 日志**：查看 `logs/error.log` 是否有错误信息

```bash
# 查看容器状态
docker compose ps

# 查看 Nginx 日志
docker compose logs nginx

# 查看错误日志
tail -f logs/error.log
```

---

## 第五步：配置 HTTPS（可选，推荐）

为了网站安全，建议配置 HTTPS（SSL 证书）。

> 💡 **详细说明：** 关于 SSL 证书的类型、如何选择、免费 vs 付费证书的对比，请查看 [SSL证书选购指南.md](./SSL证书选购指南.md)

### 5.1 使用 Let's Encrypt 免费证书

#### 安装 Certbot

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install certbot python3-certbot-nginx

# CentOS/RHEL
sudo yum install certbot python3-certbot-nginx
```

#### 获取证书

```bash
sudo certbot --nginx -d guopengfei.top -d www.guopengfei.top
```

Certbot 会自动：
- 获取 SSL 证书
- 配置 Nginx 使用 HTTPS
- 设置自动续期

#### 测试自动续期

```bash
sudo certbot renew --dry-run
```

### 5.2 使用购买的 SSL 证书

如果您已经购买了 SSL 证书，请查看详细的配置指南：

> 📖 **详细步骤：** [SSL证书使用指南.md](./SSL证书使用指南.md)
> 
> 包含完整的步骤：
> - 如何签发证书
> - 如何验证域名所有权
> - 如何下载证书
> - 如何配置到 Nginx
> - 如何测试 HTTPS

**快速步骤：**
1. 点击"签发"按钮，填写域名信息
2. 选择验证方式（DNS 验证或文件验证）
3. 等待证书签发完成（DV 证书通常 5-10 分钟）
4. 下载证书文件（`.crt` 和 `.key` 文件）
5. 配置到 Nginx（参考下面的配置示例）

---

## 完整 Nginx 配置示例（包含 HTTPS）

如果您配置了 SSL 证书，可以添加 HTTPS 支持：

```nginx
# HTTP 服务器 - 重定向到 HTTPS
server {
    listen 80;
    server_name guopengfei.top www.guopengfei.top;
    
    # 重定向所有 HTTP 请求到 HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS 服务器
server {
    listen 443 ssl http2;
    server_name guopengfei.top www.guopengfei.top;
    
    # SSL 证书配置（如果使用 Let's Encrypt，Certbot 会自动配置）
    # ssl_certificate /etc/letsencrypt/live/guopengfei.top/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/guopengfei.top/privkey.pem;
    
    root /usr/share/nginx/html;
    index index.html;
    
    # ... 其他配置 ...
}
```

---

## 常见问题

### Q1: DNS 解析不生效怎么办？

**A:** 
- 检查 DNS 记录是否正确添加
- 等待更长时间（最长 48 小时）
- 尝试清除本地 DNS 缓存：
  - Windows: `ipconfig /flushdns`
  - Linux: `sudo systemd-resolve --flush-caches`
  - Mac: `sudo dscacheutil -flushcache`

### Q2: 能通过 IP 访问，但域名无法访问？

**A:** 
- 检查 DNS 解析是否生效
- 检查 Nginx 的 `server_name` 配置是否正确
- 检查防火墙和安全组是否开放 80 端口

### Q3: 如何查看 Nginx 访问日志？

**A:**
```bash
# 实时查看访问日志
tail -f logs/access.log

# 查看错误日志
tail -f logs/error.log
```

### Q4: 如何配置多个域名？

**A:** 在 `server_name` 中添加多个域名，用空格分隔：
```nginx
server_name guopengfei.top www.guopengfei.top another-domain.com;
```

---

## 完成！

配置完成后，您的网站就可以通过域名访问了！

**访问地址：**
- HTTP: `http://guopengfei.top`
- HTTPS（如果已配置）: `https://guopengfei.top`

---

## 快速检查清单

- [ ] DNS A 记录已添加（@ 和 www）
- [ ] DNS 解析已生效（使用 nslookup 验证）
- [ ] Nginx 配置已修改（server_name）
- [ ] 容器已重新构建并启动
- [ ] 防火墙已开放 80 端口
- [ ] 云服务器安全组已开放 80 端口
- [ ] 可以通过域名访问网站
- [ ] （可选）HTTPS 已配置

